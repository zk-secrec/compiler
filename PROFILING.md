# Profiling generated Rust code

The `runrust` script now has a `--flamegraph` flag for generating flamegraph of
the execution time. This gives overview of execution time broken down by the
call graph.  While this does not perfectly reflect the number of IR gates
generated by particular function it shows where the execution time goes.

This setup has only been tested on Ubuntu (setup instructions below).

## Usage

With appropriate setup the usage should be as simple as:

```bash
$ ./runrust --flamegraph \
    --public --no-debug --stores-default \
    docs/mdchk-bigint/MedicalCheck.zksc \
    docs/mdchk-bigint/{public,instance,witness}.json \
    -c circuits -o opublic > /dev/null
```

This call generates `src/Rust/flamegraph.svg` file that can be viewed with all
modern browsers. Under linux profile data are gathered with `perf` and the data
are written to `src/Rust/perf.data`.

This file can be further transformed and used by other tools like
[Firefox profiler](profiler.firefox.com/).  Make sure to have `rustfilt`
installed. The following line also shortens generated functions names to strip
the internal crate name and unique suffix.

```bash
perf script -i src/Rust/perf.data | sed -E 's/zkscc_rust::generated::(.*)_u[[:digit:]]*/\1/g' | rustfilt > zkscc_rust.perf
```

The `zkscc_rust.perf` file can be directly loaded into the profile log viewer.


## Installing dependencies (Ubuntu)

Install `perf` and other possible dependencies. Also modify the
`kernel.perf_event_paranoid` setting to make sure that `perf` does not have to
be run as root.

```bash
sudo apt install linux-tools-common linux-tools-generic linux-tools-`uname -r`
sudo sysctl -w kernel.kptr_restrict=0
sudo sysctl -w kernel.perf_event_paranoid=-1
```

To make these changes persist reboots add a file `/etc/sysctl.d/50-perf.conf` with following contents.

```
kernel.kptr_restrict=0
kernel.perf_event_paranoid=-1
```

Install [cargo-flamegraph](https://github.com/flamegraph-rs/flamegraph) as user.
Make sure that cargo install directory (usually is `~/.cargo/bin`) is found in `$PATH`.

```bash
cargo install flamegraph
```

Installing `rustfilt` is not necessary but it will help demangle function names
to more readable form.

```bash
cargo install rustfilt
```

## Troubleshooting

### It's so slow!

It should have significantly less than 2x overhead.

The issue might be with `perf` shipped with Ubuntu can be [very slow](https://michcioperz.com/post/slow-perf-script/).
Solution is to install `perf` shipped with kernel that is linked against libbfd.
We start by installing various dependencies that might be used by `perf`.

```bash
sudo apt install \
    flex \
    bison \
    libelf-dev \
    libaudit-dev \
    libdw-dev \
    libunwind-dev \
    python2-dev \
    binutils-dev \
    libnuma-dev \
    libgtk2.0-dev \
    libbfd-dev \
    libelf1 \
    libperl-dev \
    libnuma-dev \
    libslang2 libslang2-dev \
    libunwind8 libunwind8-dev \
    binutils-multiarch-dev \
    elfutils \
    libiberty-dev
```

Following commands to install `perf` to `~/.local/bin` is for my particular kernel version, substitute your own.

```bash
sudo apt install linux-source
cd <some working directory>
cp /usr/src/linux-source-5.15.0/linux-source-5.15.0.tar.bz2 .
tar xvfj linux-source-5.15.0.tar.bz2
cd linux-source-5.15.0/tools/perf
make prefix=$HOME/.local install-bin
```
